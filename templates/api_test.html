<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Testing</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0f172a; color: #e2e8f0; padding: 40px 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { font-size: 2rem; margin-bottom: 30px; color: #60a5fa; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .section { background: #1e293b; border-radius: 8px; padding: 25px; }
        h2 { color: #60a5fa; margin-bottom: 15px; font-size: 1.2rem; }
        input, textarea, button { width: 100%; padding: 10px; margin-bottom: 10px; background: #334155; border: 1px solid #475569; border-radius: 4px; color: #e2e8f0; font-family: inherit; }
        button { background: #3b82f6; cursor: pointer; font-weight: 600; }
        button:hover { background: #2563eb; }
        .output { background: #0f172a; padding: 15px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 0.85rem; max-height: 300px; overflow-y: auto; }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: #94a3b8; }
        .token-display { background: #334155; padding: 10px; border-radius: 4px; margin-bottom: 15px; word-break: break-all; font-size: 0.75rem; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>API Testing</h1>

        <div class="grid">
            <div class="section">
                <h2>Login</h2>
                <label>Email</label>
                <input type="email" id="loginEmail" value="admin@test.com">
                <label>Password</label>
                <input type="password" id="loginPassword" value="Admin123!">
                <button onclick="login()">Login</button>
                <div class="token-display" id="tokenDisplay" style="display:none;">
                    <strong>Token:</strong> <span id="tokenValue"></span>
                </div>
            </div>

            <div class="section">
                <h2>Register</h2>
                <label>Email</label>
                <input type="email" id="regEmail" placeholder="test@example.com">
                <label>Password</label>
                <input type="password" id="regPassword" placeholder="Pass123!">
                <label>First Name</label>
                <input type="text" id="regFirstName" placeholder="John">
                <label>Last Name</label>
                <input type="text" id="regLastName" placeholder="Doe">
                <button onclick="register()">Register</button>
            </div>

            <div class="section">
                <h2>Get Profile</h2>
                <button onclick="getProfile()">Get My Profile</button>
            </div>

            <div class="section">
                <h2>Products</h2>
                <button onclick="getProducts()">Get Products</button>
                <label>Create Product</label>
                <input type="text" id="productName" placeholder="Product name">
                <input type="number" id="productPrice" placeholder="Price">
                <button onclick="createProduct()">Create</button>
            </div>

            <div class="section">
                <h2>Orders</h2>
                <button onclick="getOrders()">Get Orders</button>
                <label>Create Order</label>
                <input type="text" id="orderProduct" placeholder="Product name">
                <input type="number" id="orderQuantity" placeholder="Quantity">
                <button onclick="createOrder()">Create</button>
            </div>

            <div class="section">
                <h2>Admin: Roles</h2>
                <button onclick="getRoles()">Get All Roles</button>
            </div>
        </div>

        <div class="section" style="margin-top: 20px;">
            <h2>Response</h2>
            <div class="output" id="output">Ответ появится здесь...</div>
        </div>
    </div>

    <script>
        let token = '';

        function setOutput(text, isError = false) {
            const output = document.getElementById('output');
            output.innerHTML = `<span class="${isError ? 'error' : 'success'}">${text}</span>`;
        }

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const res = await fetch('/api/auth/login/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email, password})
                });
                const data = await res.json();

                if (data.success) {
                    token = data.data.access_token;
                    document.getElementById('tokenDisplay').style.display = 'block';
                    document.getElementById('tokenValue').textContent = token.substring(0, 50) + '...';
                    setOutput(JSON.stringify(data, null, 2));
                } else {
                    setOutput(JSON.stringify(data, null, 2), true);
                }
            } catch (e) {
                setOutput('Error: ' + e.message, true);
            }
        }

        async function register() {
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const first_name = document.getElementById('regFirstName').value;
            const last_name = document.getElementById('regLastName').value;

            try {
                const res = await fetch('/api/auth/register/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email, password, password_confirm: password, first_name, last_name})
                });
                const data = await res.json();
                setOutput(JSON.stringify(data, null, 2), !data.success);
            } catch (e) {
                setOutput('Error: ' + e.message, true);
            }
        }

        async function getProfile() {
            if (!token) return setOutput('Please login first', true);

            try {
                const res = await fetch('/api/users/me/', {
                    headers: {'Authorization': 'Bearer ' + token}
                });
                const data = await res.json();
                setOutput(JSON.stringify(data, null, 2), !data.success);
            } catch (e) {
                setOutput('Error: ' + e.message, true);
            }
        }

        async function getProducts() {
            if (!token) return setOutput('Please login first', true);

            try {
                const res = await fetch('/api/products/', {
                    headers: {'Authorization': 'Bearer ' + token}
                });
                const data = await res.json();
                setOutput(JSON.stringify(data, null, 2), !data.success);
            } catch (e) {
                setOutput('Error: ' + e.message, true);
            }
        }

        async function createProduct() {
            if (!token) return setOutput('Please login first', true);

            const name = document.getElementById('productName').value;
            const price = document.getElementById('productPrice').value;

            try {
                const res = await fetch('/api/products/', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({name, price: parseFloat(price)})
                });
                const data = await res.json();
                setOutput(JSON.stringify(data, null, 2), !data.success);
            } catch (e) {
                setOutput('Error: ' + e.message, true);
            }
        }

        async function getOrders() {
            if (!token) return setOutput('Please login first', true);

            try {
                const res = await fetch('/api/orders/', {
                    headers: {'Authorization': 'Bearer ' + token}
                });
                const data = await res.json();
                setOutput(JSON.stringify(data, null, 2), !data.success);
            } catch (e) {
                setOutput('Error: ' + e.message, true);
            }
        }

        async function createOrder() {
            if (!token) return setOutput('Please login first', true);

            const product = document.getElementById('orderProduct').value;
            const quantity = document.getElementById('orderQuantity').value;

            try {
                const res = await fetch('/api/orders/', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({product, quantity: parseInt(quantity)})
                });
                const data = await res.json();
                setOutput(JSON.stringify(data, null, 2), !data.success);
            } catch (e) {
                setOutput('Error: ' + e.message, true);
            }
        }

        async function getRoles() {
            if (!token) return setOutput('Please login first', true);

            try {
                const res = await fetch('/api/admin/roles/', {
                    headers: {'Authorization': 'Bearer ' + token}
                });
                const data = await res.json();
                setOutput(JSON.stringify(data, null, 2), !data.success);
            } catch (e) {
                setOutput('Error: ' + e.message, true);
            }
        }
    </script>
</body>
</html>